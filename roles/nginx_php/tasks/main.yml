---
- name: Add PHP repository
  apt_repository:
    repo: ppa:ondrej/php
    state: present

- name: Update apt cache after adding PHP repo
  apt:
    update_cache: yes

- name: Install Nginx
  apt:
    name: nginx
    state: present

- name: Check available PHP versions
  shell: "apt-cache search '^php[0-9]\\.[0-9]-fpm$' | head -5"
  register: available_php_versions
  changed_when: false
  check_mode: no

- name: Debug available PHP versions
  debug:
    msg: "Available PHP versions: {{ available_php_versions.stdout_lines }}"

- name: Set fallback PHP version if 8.1 not available
  set_fact:
    actual_php_version: "{{ available_php_versions.stdout_lines | first | regex_replace('^php([0-9]\\.[0-9])-fpm.*', '\\1') if available_php_versions.stdout_lines else '7.4' }}"
  when: available_php_versions.stdout is not search('php8.1-fpm')

- name: Use configured PHP version if available
  set_fact:
    actual_php_version: "{{ php_version }}"
  when: available_php_versions.stdout is search('php' + php_version + '-fpm')

- name: Debug PHP version selection
  debug:
    msg: "Using PHP version: {{ actual_php_version }}"

- name: Install PHP and extensions
  apt:
    name:
      - php{{ actual_php_version }}-fpm
      - php{{ actual_php_version }}-cli
      - php{{ actual_php_version }}-curl
      - php{{ actual_php_version }}-mbstring
      - php{{ actual_php_version }}-json
      - php{{ actual_php_version }}-pgsql
      - php{{ actual_php_version }}-redis
      - php{{ actual_php_version }}-gd
      - php{{ actual_php_version }}-xml
      - php{{ actual_php_version }}-zip
      - php{{ actual_php_version }}-bcmath
    state: present

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'

- name: Create application subdirectories
  file:
    path: "{{ app_dir }}/{{ item }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  loop:
    - public
    - routes
    - lib
    - config
    - logs

- name: Configure PHP-FPM pool
  template:
    src: php-fpm-pool.conf.j2
    dest: /etc/php/{{ actual_php_version }}/fpm/pool.d/{{ domain }}.conf
    backup: yes
  notify: restart php-fpm

- name: Remove default PHP-FPM pool
  file:
    path: /etc/php/{{ actual_php_version }}/fpm/pool.d/www.conf
    state: absent
  notify: restart php-fpm

- name: Configure Nginx virtual host
  template:
    src: nginx_vhost.j2
    dest: /etc/nginx/sites-available/{{ domain }}
    backup: yes
  notify: restart nginx

- name: Enable Nginx site
  file:
    src: /etc/nginx/sites-available/{{ domain }}
    dest: /etc/nginx/sites-enabled/{{ domain }}
    state: link
    force: yes
  notify: restart nginx
  ignore_errors: yes

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Configure logrotate for application logs
  copy:
    content: |
      {{ app_dir }}/logs/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 640 {{ app_user }} {{ app_group }}
          postrotate
              systemctl reload nginx > /dev/null 2>&1 || true
          endscript
      }
    dest: /etc/logrotate.d/{{ domain }}

- name: Check if nginx service exists
  stat:
    path: "{{ item }}"
  register: nginx_service_checks
  loop:
    - /lib/systemd/system/nginx.service
    - /usr/lib/systemd/system/nginx.service
  check_mode: no

- name: Check if php-fpm service exists
  stat:
    path: "{{ item }}"
  register: php_fpm_service_checks
  loop:
    - /lib/systemd/system/php{{ actual_php_version }}-fpm.service
    - /usr/lib/systemd/system/php{{ actual_php_version }}-fpm.service
  check_mode: no

- name: Set service exists facts
  set_fact:
    nginx_service_exists: "{{ nginx_service_checks.results | selectattr('stat.exists') | list | length > 0 }}"
    php_fpm_service_exists: "{{ php_fpm_service_checks.results | selectattr('stat.exists') | list | length > 0 }}"

- name: Start and enable nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
  when: nginx_service_exists
  ignore_errors: yes

- name: Start and enable PHP-FPM
  systemd:
    name: php{{ actual_php_version }}-fpm
    state: started
    enabled: yes
  when: php_fpm_service_exists
  ignore_errors: yes

- name: Debug nginx service issue
  debug:
    msg: "Nginx service not found. Checked: /lib/systemd/system/ and /usr/lib/systemd/system/"
  when: not nginx_service_exists

- name: Debug PHP-FPM service issue
  debug:
    msg: "PHP-FPM service not found. Checked: /lib/systemd/system/ and /usr/lib/systemd/system/ for php{{ actual_php_version }}-fpm.service"
  when: not php_fpm_service_exists
